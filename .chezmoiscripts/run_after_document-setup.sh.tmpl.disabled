#!/bin/bash

# Document the complete dotfiles setup and create usage guides
# Generates comprehensive documentation for the migrated system

# Simple logging functions
log_success() { echo "✅ $*"; }
log_info() { echo "ℹ️  $*"; }
log_warning() { echo "⚠️  $*"; }
log_error() { echo "❌ $*"; }

echo "📚 Documenting dotfiles setup..."

# Create documentation directory
DOCS_DIR="$HOME/.dotfiles/docs"
mkdir -p "$DOCS_DIR"

# Generate machine-specific documentation
cat > "$DOCS_DIR/machine-info.md" << 'EOF'
# Machine Configuration

**Generated**: $(date)

## System Information
- **OS**: {{ .chezmoi.os | title }} {{ .chezmoi.arch }}
- **Hostname**: {{ .chezmoi.hostname }}
- **Username**: {{ .chezmoi.username }}
- **Home Directory**: {{ .chezmoi.homeDir }}

## Platform Configuration
- **Operating System**: {{ .chezmoi.os | title }}
- **Architecture**: {{ .chezmoi.arch }}
{{- if eq .chezmoi.os "linux" }}
- **WSL Environment**: {{ if (env "WSL_DISTRO_NAME") }}Yes ({{ env "WSL_DISTRO_NAME" }}){{ else }}No{{ end }}
{{- end }}

## Chezmoi Configuration
- **Source Directory**: {{ .chezmoi.sourceDir }}
- **Config File**: {{ .chezmoi.configFile }}
- **Encryption**: Age with Lastpass key storage

## Hardware Information
{{- if eq .chezmoi.os "darwin" }}
- **Architecture**: {{ .chezmoi.arch }}
- **Platform**: Apple Silicon/Intel Mac
{{- end }}

## Installed Features

### Core Tools
- Modern CLI tools (bat, eza, fd, ripgrep, fzf)
- Git configuration and templates
- Shell optimization (zsh with zinit)
- Cross-platform compatibility

{{- if eq .chezmoi.os "darwin" }}
### macOS Specific
- Homebrew package management
- macOS system optimizations
- Platform-specific utilities
{{- end }}

{{- if eq .chezmoi.os "linux" }}
### Linux Specific
- Package manager detection
- Linux-specific configurations
{{- if (env "WSL_DISTRO_NAME") }}
- WSL integration and optimizations
{{- end }}
{{- end }}

### Security Features
- SSH configuration encrypted with age
- Lastpass integration for key management
- Private file protection
- Secure secret synchronization

EOF

# Generate usage guide
cat > "$DOCS_DIR/usage-guide.md" << 'EOF'
# Dotfiles Usage Guide

## Daily Workflow

### Making Changes
```bash
# Edit configuration files
chezmoi edit ~/.zshrc
chezmoi edit ~/.gitconfig
chezmoi edit ~/.config/starship.toml

# Preview changes
chezmoi diff

# Apply changes
chezmoi apply

# Add new files
chezmoi add ~/.new-config-file
```

### Multi-Machine Sync
```bash
# Push changes to other machines
chezmoi git push

# Pull changes on other machines
chezmoi update  # Pulls AND applies changes
```

### New Machine Setup
```bash
# One-command setup
chezmoi init --apply {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi

# Or step-by-step
chezmoi init {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi
chezmoi apply
```

## Key Commands

### Configuration Management
- `chezmoi edit <file>` - Edit template files
- `chezmoi cat <file>` - Preview rendered content
- `chezmoi diff` - Show pending changes
- `chezmoi apply` - Apply all changes
- `chezmoi status` - Check status

### Secret Management
- Secrets are encrypted with age
- Encryption key stored in Lastpass as "chezmoi-age-key"
- SSH config is fully encrypted and templated

### Troubleshooting
- `chezmoi doctor` - System health check
- `chezmoi verify` - Verify all files
- `benchmark-shell` - Performance testing
- `chezmoi purge` - Emergency reset

## Template Features

### Platform Detection
Templates automatically adapt based on:
- Operating system (macOS, Linux, Windows)
- Architecture (x86_64, arm64)
- WSL environment detection

### Conditional Loading
```bash
{{- if eq .chezmoi.os "darwin" }}
# macOS-specific configuration  
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Linux-specific configuration
{{- end }}

{{- if (env "WSL_DISTRO_NAME") }}
# WSL-specific configuration
{{- end }}
```

### Helper Functions
- Use `.chezmoitemplates/helpers.tmpl` for common patterns
- Pre-defined functions for platform detection
- Resource detection helpers
- Package manager detection

## Backup and Recovery

### Backup Strategy
- All configurations tracked in Git
- Encrypted secrets committed safely
- Original files backed up during migration
- Git tags for version tracking

### Recovery Process
```bash
# Full reset
chezmoi purge
chezmoi init --apply {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi

# Partial recovery
chezmoi apply --force
```

## Performance Optimization

### Startup Optimization
- Templates compiled for faster rendering
- Zsh completions cached
- Plugin loading optimized with Zinit turbo mode

### System Optimization
{{- if eq .chezmoi.os "darwin" }}
- macOS animations disabled for speed
- File watcher limits increased for development
- Dock and Finder optimized
{{- end }}

### Monitoring
- `benchmark-shell` - Performance testing
- Shell startup time tracking
- Template rendering performance

EOF

# Generate troubleshooting guide
cat > "$DOCS_DIR/troubleshooting.md" << 'EOF'
# Troubleshooting Guide

## Common Issues

### Template Errors
```bash
# Debug template syntax
chezmoi execute-template < template.tmpl

# Show template data
chezmoi data

# Check template variables
echo '{{.chezmoi.os}}' | chezmoi execute-template
```

### Encryption Issues
```bash
# Verify age key
chezmoi cat ~/.ssh/config

# Regenerate key if needed
age-keygen > ~/.config/chezmoi/key.txt
# Update key in Lastpass

# Re-encrypt files
chezmoi re-add ~/.ssh/config
```

### Performance Issues
```bash
# Benchmark current performance
benchmark-shell

# Optimize shell startup
zinit compile --all
zcompile ~/.zshrc

# Clear caches
rm -rf ~/.cache/shell/*
rm -rf ~/.cache/chezmoi/*
```

### Git Issues
```bash
# Reset chezmoi repository
chezmoi cd
git status
git reset --hard origin/main

# Force re-apply
chezmoi apply --force
```

### Platform Detection Issues
```bash
# Check detected values
chezmoi data | grep -A 20 '"chezmoi"'

# Verify machine configuration
cat ~/.config/chezmoi/chezmoi.toml
```

## Getting Help

### Chezmoi Resources
- Documentation: https://www.chezmoi.io/
- GitHub Issues: https://github.com/twpayne/chezmoi/issues
- Discussions: https://github.com/twpayne/chezmoi/discussions

### Your Setup
- Repository: https://github.com/{{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi
- Configuration: ~/.config/chezmoi/chezmoi.toml
- Source: {{ .chezmoi.sourceDir }}

EOF

# Generate advanced usage documentation
cat > "$DOCS_DIR/advanced-usage.md" << 'EOF'
# Advanced Usage

## Template Development

### Custom Helpers
Create reusable template functions in `.chezmoitemplates/`:
```go
{{- define "my_helper" -}}
Custom template logic here
{{- end -}}
```

### Platform-Based Decisions
```bash
{{- if eq .chezmoi.os "darwin" -}}
# macOS specific configuration
{{- end -}}

{{- if eq .chezmoi.arch "arm64" -}}
# Apple Silicon optimization
{{- end -}}

{{- if and (eq .chezmoi.os "linux") (env "WSL_DISTRO_NAME") -}}
# WSL-specific configuration
{{- end -}}
```

## Automation Scripts

### Creating Run Scripts
- `run_before_*` - Executes before applying configs
- `run_after_*` - Executes after applying configs  
- `run_once_*` - Executes only once per machine

### Script Templates
All scripts support full templating:
```bash
#!/bin/bash
{{- if .development }}
echo "Setting up development environment..."
{{- end }}
```

## Advanced Security

### Additional Encryption
```bash
# Encrypt entire directories
chezmoi add --encrypt ~/.private-dir

# Use GPG instead of age
chezmoi add --encrypt --gpg ~/.secret-file
```

### Custom Secret Sources
```bash
# Use 1Password
{{ onepassword "item" "vault" }}

# Use Bitwarden  
{{ bitwarden "item-id" }}

# Use custom command
{{ output "my-secret-script" }}
```

## Integration Examples

### CI/CD Integration
```yaml
# GitHub Actions example
- name: Apply dotfiles
  run: |
    chezmoi init --apply {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi
```

### Docker Integration
```dockerfile
# Install dotfiles in container
RUN chezmoi init --apply {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi
```

### Ansible Integration
```yaml
- name: Setup dotfiles
  shell: chezmoi init --apply {{- if hasKey . "github_username" -}}{{ .github_username }}{{- else -}}elliotboney{{- end -}}/dotfiles-chezmoi
```

EOF

log_success "Documentation generated in $DOCS_DIR"
log_info "Available guides:"
log_info "  • machine-info.md - Current machine configuration"
log_info "  • usage-guide.md - Daily workflow and commands"
log_info "  • troubleshooting.md - Problem solving guide"
log_info "  • advanced-usage.md - Power user features"

echo ""
log_info "📖 View documentation: ls -la $DOCS_DIR"
log_info "🔗 Online docs: https://www.chezmoi.io/"
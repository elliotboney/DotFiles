#!/bin/bash

# Install essential tools before applying dotfiles
# This ensures dependencies are available when configs are applied

set -e

echo "🔧 Installing essential tools for dotfiles..."

# Check if Homebrew is installed (macOS/Linux)
{{- if eq .chezmoi.os "darwin" }}
if ! command -v brew >/dev/null 2>&1; then
    echo "📦 Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install essential tools via Homebrew
echo "🍺 Installing essential brew packages..."
brew install --quiet git zsh starship || true

# Development tools
brew install --quiet neovim ripgrep fd fzf bat eza git-delta || true
echo "✅ Development tools installed"

{{- else if eq .chezmoi.os "linux" }}
# Linux package installation
if command -v apt >/dev/null 2>&1; then
    sudo apt update -qq
    sudo apt install -y git zsh curl wget || true
elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y git zsh curl wget || true
elif command -v pacman >/dev/null 2>&1; then
    sudo pacman -S --noconfirm git zsh curl wget || true
fi

# Install Starship prompt
if ! command -v starship >/dev/null 2>&1; then
    echo "🚀 Installing Starship prompt..."
    curl -sS https://starship.rs/install.sh | sh -s -- --yes
fi

# Install zinit for zsh plugin management
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [[ ! -d "$ZINIT_HOME" ]]; then
    echo "⚡ Installing Zinit (zsh plugin manager)..."
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME" || true
fi

# Install oh-my-zsh if not present
if [[ ! -d "${HOME}/.oh-my-zsh" ]]; then
    echo "🐚 Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || true
fi

{{- end }}

{{- if eq .chezmoi.os "darwin" }}
# macOS specific: Set zsh as default shell
if [[ "$SHELL" != *"zsh" ]]; then
    echo "🐚 Setting zsh as default shell..."
    chsh -s $(which zsh) || true
fi
{{- end }}

echo "✅ Essential tools installation complete!"
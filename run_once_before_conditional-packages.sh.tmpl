#!/bin/bash

# Conditional package installation based on machine type and capabilities
# Runs before dotfiles are applied to ensure optimal package selection

set -e

echo "📦 Installing conditional packages based on machine configuration..."

{{- if eq .chezmoi.os "darwin" }}
# Ensure Homebrew is available
if ! command -v brew >/dev/null 2>&1; then
    echo "❌ Homebrew not found. Please install Homebrew first."
    exit 1
fi

echo "🍺 Installing macOS-specific packages..."

# Core utilities that improve macOS experience
brew install --quiet coreutils findutils gnu-sed gnu-tar || true

# Development tools for macOS
echo "💻 Installing development packages..."
brew install --quiet \
    git-delta \
    bat \
    eza \
    fd \
    ripgrep \
    fzf \
    jq \
    yq \
    htop \
    neovim || true

# Language-specific tools (Node.js managed by nvm)
brew install --quiet \
    python@3.12 \
    go \
    rust || true

# macOS development utilities
brew install --quiet \
    mas \
    duti \
    blueutil \
    terminal-notifier || true

# Personal machine packages
echo "🏠 Installing personal machine packages..."
brew install --quiet \
    spotify \
    discord \
    vlc \
    transmission || true

# Personal productivity tools
brew install --quiet \
    obsidian \
    raycast \
    cleanmymac || true

# Work machine packages
echo "💼 Installing work machine packages..."
brew install --quiet \
    slack \
    zoom \
    docker \
    kubectl || true

# Work productivity tools
brew install --quiet \
    notion \
    figma \
    postman || true

{{- else if eq .chezmoi.os "linux" }}
# Linux package management
echo "🐧 Installing Linux packages..."

# Development packages for Linux
if command -v apt >/dev/null 2>&1; then
    sudo apt update -qq
    sudo apt install -y \
        build-essential \
        curl \
        git \
        vim \
        htop \
        tree \
        jq \
        ripgrep \
        fd-find || true
elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y \
        gcc \
        make \
        curl \
        git \
        vim \
        htop \
        tree \
        jq || true
elif command -v pacman >/dev/null 2>&1; then
    sudo pacman -S --noconfirm \
        base-devel \
        curl \
        git \
        vim \
        htop \
        tree \
        jq \
        ripgrep \
        fd || true
fi

{{- if .server }}
# Minimal server packages
if command -v apt >/dev/null 2>&1; then
    sudo apt update -qq
    sudo apt install -y \
        curl \
        git \
        vim \
        htop \
        tree || true
fi
{{- end }}
{{- end }}

# Install language-specific package managers
echo "🔧 Setting up language package managers..."

# Node.js package management
{{- if ne .chezmoi.os "darwin" }}
# Skip npm global installs on macOS since we use nvm
if command -v npm >/dev/null 2>&1; then
    echo "📦 Installing global Node.js packages..."
    npm install -g \
        typescript \
        @typescript-eslint/parser \
        @typescript-eslint/eslint-plugin \
        eslint \
        prettier \
        nodemon \
        pm2 || true
fi
{{- else }}
echo "📦 Skipping npm global installs on macOS (using nvm instead)"
{{- end }}

# Language packages are installed via run_once_install-language-packages.sh.tmpl
echo "📦 Language packages (Python, Rust) are installed separately on first run"

# Conditional installations based on hardware/capabilities
{{- if eq .chezmoi.arch "arm64" }}
echo "💪 ARM64 architecture detected - installing optimized packages..."
{{- if eq .chezmoi.os "darwin" }}
# Apple Silicon specific optimizations
brew install --quiet \
    docker-buildx \
    lima || true

# Install based on available system resources
TOTAL_RAM=$(( $(sysctl -n hw.memsize 2>/dev/null || echo "8589934592") / 1024 / 1024 / 1024 ))
if [ "$TOTAL_RAM" -gt 16 ]; then
    echo "💾 High memory system detected (${TOTAL_RAM}GB) - installing memory-intensive tools..."
    {{- if eq .chezmoi.os "darwin" }}
    brew install --quiet \
        docker-desktop \
        intellij-idea \
        webstorm || true
    {{- end }}
fi
{{- end }}
{{- end }}

echo "✅ Conditional package installation complete!"
echo "📊 Installed packages optimized for:"
echo "  • Platform: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo "  • Features: All enabled"
echo "  • Memory: ${TOTAL_RAM}GB"